<!DOCTYPE HTML>
<html>
<head>
	<hta:application
   showintaskbar = "no"
   caption = "no"
   border = "thick"
   contextmenu = "no"
   icon = "path_to_icon.ico"
   innerborder = "no"
   scroll = "no"
   singleinstance = "yes"
   resizable = "no"
   windowState = "maximize"
>
<title>MetroidVania</title>
<meta name="description" content="melonJS homepage" />
<meta name="keywords" content="melonJS, HTML5, javascript, game, engine, framework" />
<!-- <link rel="stylesheet" type="text/css" href="http://nsjof.org/game/melonEx/melonJS/examples/platformer//style/style.css" title="style" /> -->
<style type="text/css">
	canvas {
		display: block;
		tabindex:1;
		image-rendering: optimizeSpeed;
		image-rendering: -moz-crisp-edges;
		image-rendering: -o-crisp-edges;
		image-rendering: -webkit-optimize-contrast;
		image-rendering: optimize-contrast;
		-ms-interpolation-mode: nearest-neighbor;
	}
</style>
</head>

 <!--  <div id="main">
    <div id="site_content"> -->
<!-- 		<center>
		<div id="content"> -->
			<!-- Canvas -->
			<div id="screen" style=""></div>

			<!-- Right Login Screen -->
		<!-- 	<div id="signin" style="float:left; width:15%; margin:15px;">
				<h1>Please enter your name</h1>
				<input type='text' id='userNameField'>
				<button value='Start' onclick='userName = $("#userNameField").val(); socketResponse("setname", $("#userNameField").val()); $("#signin").hide();'>Start</button>
			</div>

			<div id="userhead" style="float:left; width:15%; margin:15px;"><h1>User List: id#<script>document.write(clientid)</script></h1><hr>
				<div id="leave"><button onclick='socketResponse("leave", userName); window.location = "http://www.google.com/";'>Leave</button></div>
				<div id="userlist" style=""></div>
			</div> -->


<script type="text/javascript" src="build/melonJS-0.9.7.js"></script>
<script type="text/javascript" src="plugins/debug/debugPanel.js"></script>
<script type="text/javascript" src="entities/screen.js"></script>
<script type="text/javascript" src="entities/playerEntity.js"></script>
<script type="text/javascript" src="entities/player2Entity.js"></script>
<script type="text/javascript" src="entities/enemyEntities.js"></script>
<script type="text/javascript" src="entities/itemEntities.js"></script>
<script type="text/javascript" src="entities/weaponEntity.js"></script>
<script type="text/javascript" src="entities/npcEntity.js"></script>
<script src="tools/bison.js"></script>
<script type="text/javascript" src="main.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js'></script>
<script type='text/javascript' src="//rawgit.com/WebReflection/circular-json/master/build/circular-json.js"></script>
<script>

	var clientid = '';
	var clientData = new Array();
	var globalClientIndex;
	var users;
	var usersClient;
	var userName = '';
    var playerX = '';
	var playerY = '';
	var playerVelX = '';
	var playerVelY = '';
	var userlist = '';
	var currentAnim = '';
	var usernumber;
	var moveLeft = false;
	var moveRight = false;
	var left = false;
	var right = false;
	var up = false;
	var player2Action = '';
	var coinid = null;
	var levelDirection = '';
	var levelDirectionY = '';
	var playerMap = '';
	var visiblePlayer = '';
	var socketUpdated = '';
	var playerXlast = '';
	var playerYlast = '';
	var nextScreenY = '';
	var nextScreenX = '';
	var nextScreenVelX = '';
	var menuSelected = 0;
	var samemap = '';
	var capXP = 15;
	var capHP = 25;
	var lastLevelHeight = '';
	var playerInfo = new Object();
	var socketObjects = [];
	var enemyZ = 100;
	var hostObject = {};

	// Info
	playerInfo.xp = 0;
	playerInfo.lvl = 1;
	playerInfo.strength = 3;
	playerInfo.hitpoints = 50;
	playerInfo.hearts = 10;

	// Weapons
	playerInfo.weapons = new Array();
	playerInfo.weapons = ['whip'];


	var lvlcap = Array();
	for(i=1; i<50; i++) {
		capXP += 30;
		lvlcap[i] = capXP;
	}

	var lvlMaxHealth = Array();
	for(i=1; i<50; i++) {
		capHP += 20;
		lvlMaxHealth[i] = capHP;
	}

	var socketHost = location.href;
	var socket = io.connect(socketHost);

	socket.on('assignid', function (id) {
		clientid = id;
	});

  socket.on('removeplayer', function (clientid) {
  	playerX.splice(clientid, 1);
  	playerY.splice(clientid, 1);
  });

  // Updates ALL socketObjects with each server loop iteration
  socket.on('updateobjects', function (objects) {
  	if (objects.length > 0 && clientid > 0) {
  		socketObjects = JSON.parse(objects);
  	}
  });

  // Updates Host object directly
  socket.on('updatehostobject', function (serverObject) {
  	if (clientid == 0) {
			var hostObject = me.game.editEntityByGUID(serverObject.GUID, serverObject);
		}
  });

  socket.on('addhostobject', function(serverObject) {
  	if (clientid == 0) {
			// Is the object already in the game?
			var foundHostObj = false;
			if (me.game.getEntityByGUID(serverObject.GUID) !== null) {
				foundHostObj = true;
			}

			// If the object has not been added to non-host client
			if (foundHostObj == false && serverObject.settings.entityName) {
				var hostedEntity = new window[serverObject.settings.entityName]( serverObject.pos.x, serverObject.pos.y, { image: serverObject.settings.image, spritewidth: serverObject.settings.spritewidth, spriteheight: serverObject.settings.spriteheight, GUID: serverObject.GUID});

	 			me.game.add(hostedEntity, enemyZ++);
				me.game.sort();
			}
		}
  });

   // Passing input from browser to socket.io server
	var socketResponse = function(type, data) {
		var socket = io.connect(socketHost);
	 	socket.emit(type, data);
	};

	// Updates some socketObjects keys
	var updateSocketObjectKeys = function(object, i) {
	  for (key in object) {
	    if (socketObjects[i][key]) {
	      socketObjects[i][key] = object[key];
	    }
	  }
	  return true;
	};

	// Updates some Entity keys
	var updateHostEntityKeys = function(serverObject) {
		for (key in serverObject) {
	    if (hostObject) {
	      hostObject[key] = serverObject[key];
	    }
	  }
	  return true;
	};

	// For logging socketObjects
	// setInterval(function(){
	// 	console.log(socketObjects);
	// }, 2500);

	setInterval(function(){
		var foundGameObj = [];
		// If Host, update all socketObjects to server
		if (socketObjects.length > 0 && clientid == 0) {
			socketResponse('updateobjects', JSON.stringify(socketObjects));

			// Check if we should remove from host
			for(var i = 0; i < socketObjects.length; i++) {
				// Checking if we should remove object
				if (socketObjects[i].dead == true) {
					socketObjects.splice(i,1);
				}
			}
		}

		// If Slave, read objects from Servexr and add to game if not added yet
		if (socketObjects && clientid > 0 && me.state.ready) {
			for(var i = 0; i < socketObjects.length; i++) {

				foundGameObj[i] = false;
				if (me.game.getEntityByGUID(socketObjects[i].GUID) !== null) {
					foundGameObj[i] = true;
				}

				// If the object has not been added to non-host client
				if (foundGameObj[i] == false && socketObjects[i].settings.entityName && !socketObjects[i].dead) {
					var hostedEntity = new window[socketObjects[i].settings.entityName]( socketObjects[i].pos.x, socketObjects[i].pos.y, { image: socketObjects[i].settings.image, spritewidth: socketObjects[i].settings.spritewidth, spriteheight: socketObjects[i].settings.spriteheight, GUID: socketObjects[i].GUID});

		 			me.game.add(hostedEntity, enemyZ++);
					me.game.sort();
				}
			}
	    }
  	}, 60);

</script>
</body>
</html>
